name: Generate Obsidian Template Release

on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨2点检查
  workflow_dispatch: # 支持手动触发

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Latest Plugins
        id: download_plugins
        run: |
          PLUGINS=("No-Instructions/Relay" "remotely-save/remotely-save")
          VERSION_INFO=""
          
          for repo in "${PLUGINS[@]}"; do
            plugin_id=$(echo $repo | cut -d'/' -f2)
            plugin_dir=".obsidian/plugins/$plugin_id"
            mkdir -p "$plugin_dir"
            
            echo "Fetching latest release for $repo..."
            latest_json=$(curl -s "https://api.github.com/repos/$repo/releases/latest")
            tag=$(echo "$latest_json" | jq -r '.tag_name')
            VERSION_INFO="$VERSION_INFO | $plugin_id: $tag"
            
            assets=$(echo "$latest_json" | jq -r '.assets[].browser_download_url')
            for url in $assets; do
              filename=$(basename "$url")
              if [[ "$filename" == "main.js" || "$filename" == "manifest.json" || "$filename" == "styles.css" ]]; then
                curl -L -o "$plugin_dir/$filename" "$url"
              fi
            done
          done
          echo "versions=$VERSION_INFO" >> $GITHUB_OUTPUT

      - name: Create Zip Package
        run: |
          # 打包当前目录（包含刚下载到 .obsidian/plugins 的文件）
          # 排除 git 相关文件，确保下载包干净
          zip -r obsidian-template.zip . -x "*.git*" ".github*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest-build"
          name: "Obsidian 自动同步模板"
          body: |
            ### 自动构建说明
            这是一个包含最新同步插件的 Obsidian 仓库模板。
            
            **包含插件版本:**
            ${{ steps.download_plugins.outputs.versions }}
            
            **使用方法:**
            1. 下载下方的 `obsidian-template.zip`
            2. 解压并用 Obsidian 打开
            3. 配置 Remotely Save 和 Relay 即可
          files: obsidian-template.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}