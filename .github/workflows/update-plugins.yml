name: Update Obsidian Plugins

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'  # 每天午夜运行
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install unzip and jq
        run: sudo apt-get update && sudo apt-get install -y unzip jq

      - name: Check for updates and download
        id: check
        run: |
          PLUGINS=(
            "remotely-save/remotely-save:remotely-save"
            "No-Instructions/Relay:system3-relay"
          )

          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"

          get_current_version() {
            local folder=$1
            local manifest=".obsidian/plugins/$folder/manifest.json"
            if [ -f "$manifest" ]; then
              jq -r '.version' "$manifest"
            else
              echo "0.0.0"
            fi
          }

          compare_versions() {
            local v1=$1
            local v2=$2
            [ "$v1" = "$(echo -e "$v1\n$v2" | sort -V | tail -n1)" ] && [ "$v1" != "$v2" ]
          }

          download_and_extract() {
            local repo=$1
            local folder=$2
            local latest_release=$3

            echo "Fetching assets for $repo"
            local assets=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$latest_release" | jq '.assets')
            echo "Assets: $assets"

            # Define the files to download
            local files_to_download=("main.js" "manifest.json" "styles.css")

            mkdir -p ".obsidian/plugins/$folder"

            for file in "${files_to_download[@]}"; do
              local asset_url=$(echo "$assets" | jq -r ".[] | select(.name == \"$file\") | .browser_download_url")

              if [ -z "$asset_url" ]; then
                echo "File $file not found in release assets for $repo"
                continue
              fi

              echo "Downloading $file from $asset_url"
              curl -L -o ".obsidian/plugins/$folder/$file" "$asset_url"
            done
          }

          has_updates=false

          for plugin in "${PLUGINS[@]}"; do
            IFS=':' read -r repo folder <<< "$plugin"
            echo "Checking plugin: $repo -> $folder"
            current_version=$(get_current_version "$folder")
            echo "Current version: $current_version"

            latest_release_url="https://api.github.com/repos/$repo/releases/latest"
            latest_version=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$latest_release_url" | jq -r '.tag_name' | sed 's/^v//')
            echo "Latest version: $latest_version"

            if compare_versions "$latest_version" "$current_version"; then
              echo "Updating $repo from $current_version to $latest_version"
              download_and_extract "$repo" "$folder" "$latest_release_url"
              has_updates=true
            else
              echo "No update needed for $repo (current: $current_version, latest: $latest_version)"
            fi
          done

          if $has_updates; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check.outputs.has-updates == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        if: steps.check.outputs.has-updates == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update Obsidian plugins to latest releases"
            git push
          fi

      - name: Create zip
        if: steps.check.outputs.has-updates == 'true'
        run: |
          zip -r skeleton-template.zip . -x ".git/*" ".github/*"

      - name: Create release
        if: steps.check.outputs.has-updates == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v$(date +%Y%m%d)
          name: Template Update $(date +%Y-%m-%d)
          body: Updated plugins to latest versions
          files: skeleton-template.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}